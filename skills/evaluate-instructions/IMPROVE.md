# 에이전트 설정 파일 자기 개선 가이드

## 트리거 조건

- evaluate-agents 평가가 완료되어 보고서가 출력된 상태
- 사용자가 명시적으로 개선을 요청한 경우

## 실행 흐름

### 1단계: 평가 결과 확인

- 직전 evaluate-agents 평가 보고서를 참조한다
- 각 카테고리(A-H)별 점수와 개선 권고를 확인한다
- 개선 우선순위: 점수가 낮은 카테고리부터 (F등급 → E → D → C → B 순)

### 2단계: 대상 파일 스코프 판별

개선 대상 파일이 어떤 범위(scope)의 설정인지 먼저 판별한다. 스코프에 따라 대화 내역 탐색 범위와 분석 관점이 달라진다.

#### 판별 기준

| 스코프             | 조건                                                | 예시 경로                                                                  |
| ------------------ | --------------------------------------------------- | -------------------------------------------------------------------------- |
| **User-wide**      | 파일이 홈 디렉토리 하위의 글로벌 설정 저장소에 위치 | `~/.agents/AGENTS.md`, `~/.claude/AGENTS.md`, `~/.cursor/rules/global.mdc` |
| **Workspace-wide** | 파일이 특정 프로젝트 워크스페이스 내에 위치         | `/projects/my-app/AGENTS.md`, `./CLAUDE.md`, `.cursor/rules/project.mdc`   |

판별 방법:

1. 대상 파일의 **절대 경로**를 확인한다
2. 현재 워크스페이스 디렉토리와 비교한다
3. 파일이 `~/.agents/`, `~/.claude/`, `~/.roo/` 등 글로벌 설정 디렉토리에 속하면 → **User-wide**
4. 파일이 특정 프로젝트 디렉토리 내에 있으면 → **Workspace-wide**
5. 판별이 모호한 경우 사용자에게 확인한다

### 3단계: 대화 내역 탐색

에이전트가 스스로 본인의 대화 내역을 찾도록 한다.

- 현재 실행 중인 에이전트의 종류를 식별한다 (Roo Code, Claude Code, Cursor, Windsurf, Copilot 등)
- 해당 에이전트의 대화 내역 저장 위치를 탐색한다
  - 파일 시스템에서 에이전트별 대화/세션/태스크 데이터가 저장되는 위치를 찾는다
  - 프로젝트 루트, 홈 디렉토리, 에이전트 설정 디렉토리 등을 순차적으로 탐색한다
  - 대화 내역이 없거나 접근 불가능한 경우, 해당 단계를 건너뛰고 평가 결과만으로 개선을 진행한다
- 탐색 시 참고할 일반적 위치 패턴:
  - 프로젝트 내: `.claude/`, `.cursor/`, `.roo/`, `.copilot/` 등 에이전트 설정 디렉토리 하위
  - 사용자 홈: 에이전트별 글로벌 설정/캐시 디렉토리 (에이전트가 자신의 저장 경로를 알고 있을 것)
  - VS Code 확장 저장소: `globalStorage/` 하위의 에이전트 확장 디렉토리

#### 스코프별 대화 내역 필터링

**User-wide인 경우:**

- **전체 대화 기록**을 탐색 대상으로 한다 (모든 프로젝트의 대화 포함)
- 특정 프로젝트에 종속되지 않는 **범용 패턴**을 찾는 것이 목적이므로, 프로젝트 경로로 필터링하지 않는다

**Workspace-wide인 경우:**

- 해당 프로젝트와 **연관된 대화 기록만** 탐색 대상으로 한다
- 필터링 방법:
  1. 대화 내역의 메타데이터(프로젝트 경로, 워크스페이스 정보)에서 현재 프로젝트 경로와 일치하는 것만 선택
  2. 메타데이터가 없는 경우, 대화 내용에서 현재 프로젝트의 파일 경로/패키지명/디렉토리명이 언급된 것만 선택
  3. 대화 내역 저장 구조가 프로젝트별로 분리되어 있다면 해당 프로젝트 디렉토리의 대화만 읽는다

### 4단계: 대화 내역 분석 (서브에이전트 위임)

대화 내역은 컨텍스트 소모가 매우 크므로, **서브에이전트 생성이 지원되는 환경에서는 반드시 서브에이전트에게 분석을 위임**한다.

#### 4-A. 서브에이전트 지원 시 (new_task 등)

- 서브에이전트에게 다음을 전달:
  1. 대화 내역 파일 경로
  2. 현재 평가 대상 파일의 경로와 내용
  3. 평가 보고서의 개선 권고 사항
  4. **대상 파일의 스코프 (User-wide / Workspace-wide)**
  5. 스코프별 분석 관점 지시 (아래 참조)

**User-wide 분석 관점:**

- 프로젝트 도메인과 무관한 **일반적·범용적 패턴**에 집중한다
- 사용자가 여러 프로젝트에 걸쳐 에이전트를 반복적으로 교정하는 공통 패턴
- 사용자의 범용 코딩 스타일/선호 (언어·프레임워크 무관한 것: 네이밍, 커밋 메시지, 주석 스타일 등)
- 에이전트가 프로젝트와 무관하게 반복하는 일반적 실수 (과잉 설명, 불필요한 확인 질문 등)
- 사용자가 공통적으로 요청하는 워크플로우 (예: "항상 테스트 먼저 작성", "커밋 전 린트 실행")
- 특정 프로젝트에만 해당하는 규칙은 **제외**한다

**Workspace-wide 분석 관점:**

- 해당 프로젝트의 **도메인·기술 스택·구조에 특화된 패턴**에 집중한다
- 이 프로젝트에서 사용자가 에이전트를 반복적으로 교정하는 프로젝트 고유 패턴
- 프로젝트별 코딩 컨벤션/아키텍처 규칙 중 미문서화된 것
- 이 프로젝트에서 에이전트가 반복적으로 실수하는 영역 (특정 모듈, API 사용법 등)
- 프로젝트 특수 규칙/패턴 (디렉토리 구조, 네이밍 규칙, 의존성 관리 등)
- 이 프로젝트에서 자주 요청되는 작업 유형

- 서브에이전트는 분석 결과를 구조화된 형태로 반환:
  ```
  ## 대화 내역 분석 결과
  ### 스코프: [User-wide / Workspace-wide]
  ### 반복 교정 패턴
  - [패턴 1]: 빈도, 구체적 예시
  ### 미문서화된 컨벤션
  - [컨벤션 1]: 근거가 된 대화
  ### 반복 실수 영역
  - [영역 1]: 빈도, 원인 추정
  ### 자주 요청되는 작업
  - [작업 유형 1]: 빈도
  ```

#### 4-B. 서브에이전트 미지원 시

- 최근 대화 내역 중 가장 관련성 높은 일부만 선택적으로 분석한다
- 전체 대화를 로드하지 말고, 파일 목록을 먼저 확인 후 최신 N개만 읽는다
- **User-wide**: 여러 프로젝트의 대화에서 공통 패턴만 빠르게 추출한다
- **Workspace-wide**: 해당 프로젝트의 대화만 필터링하여 읽는다
- 컨텍스트 제한을 고려하여 핵심 패턴만 추출한다

### 5단계: 개선안 종합

평가 결과 + 대화 내역 분석을 종합하여 개선안을 작성한다.

#### 개선 원칙 (ACE Delta Update 방식)

1. **기존 내용 보존** — 잘 작성된 부분은 유지, 문제 있는 부분만 수정
2. **점진적 개선** — 한 번에 전체 재작성이 아닌, 카테고리별 점진 개선
3. **의미적 중복 제거** — 중복되는 지시가 있으면 통합
4. **Over-Specification 회피** — 규칙 수를 최소한으로 유지 (S\*≈0.509 임계점 인식)
5. **WHY 포함** — 각 규칙에 이유를 간결히 포함
6. **모델 세대 인식** — 최신 모델일수록 더 적은 제약이 효과적

#### 개선 우선순위

1. **즉시 반영**: 대화 내역에서 발견된 반복 교정 패턴 → 규칙으로 문서화
2. **높은 우선**: 평가 점수 60점 미만 카테고리 개선
3. **중간 우선**: 평가 점수 60-75점 카테고리 개선
4. **낮은 우선**: 평가 점수 75점 이상 카테고리 미세 조정

### 6단계: 파일 수정 적용

1. 개선안을 대상 파일에 적용한다
2. 적용 시 변경 사항을 명확히 설명한다:
   - 무엇을 변경했는지
   - 왜 변경했는지 (평가 카테고리 / 대화 내역 근거)
   - 예상 효과
3. 변경 후 재평가 점수 예측을 제공한다

### 제약 사항

- 대상 파일의 전체 재작성은 피한다 (Delta Update 원칙)
- 300줄 미만 유지를 목표로 한다
- 프로젝트의 기술 스택과 구조에 맞는 규칙만 추가한다
- 대화 내역에서 개인정보나 민감 정보가 발견되면 이를 규칙에 포함하지 않는다
- 개선 결과를 사용자에게 보여주고 확인을 받은 후 최종 적용한다
